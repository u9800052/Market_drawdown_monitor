name: Drawdown Alert

on:
  schedule:
    # "Cron Job" 語法(UTC 時間)
    # 格式: 分 時 日 月 星期
    # "30 0 * * 1-5" 代表：週一到週五的 UTC 00:30 執行(台灣上午 08:30)
    - cron: '30 0 * * 1-5'
  
  # 讓你可以在網頁上按按鈕手動測試 (Workflow Dispatch)
  workflow_dispatch:

# 預設先用最小權限
permissions:
  contents: read

concurrency:
  group: drawdown-alert-${{ github.ref }}
  cancel-in-progress: false

# 設定工作內容 (Jobs) ---
jobs:
  run-stock-check:
    runs-on: ubuntu-latest # 指定用 Linux 虛擬機跑
    timeout-minutes: 10
    
    # 只有這個 job 需要寫回 repo
    permissions:
      contents: write

    steps:
      # 步驟 A: 把程式碼抓下來
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 1

      # 步驟 B: 安裝 Python 環境
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12' # 指定 Python 版本

      # 步驟 C: 安裝 requirements.txt
      - name: Install dependencies
        run: |
          pip -m install --upgrade pip
          python -m pip install -r requirements.txt

      # 步驟 D: 執行 Python 程式
      # 關鍵：注入給程式
      - name: Run Stock Script
        env: 
          CHANNEL_ACCESS_TOKEN: ${{ secrets.CHANNEL_ACCESS_TOKEN }}
          USER_ID: ${{ secrets.USER_ID }}
        run: python main.py

      # 步驟 E: 只有當 Records.json 有變動時才 Commit
      - name: Commit and Push changes
        env:
          GH_TOKEN: ${{ github.token }}

        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add Records.json

          # 沒有變更就直接結束
          if git diff --cached --quiet -- Records.json; then
            echo "No changes in Records.json"
            exit 0
          fi

          git commit -m "Update stock records [skip ci]"

          # 只在這一步臨時用 token 推回去
          git remote set-url origin "https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git"
          git push origin "HEAD:${{ github.ref_name }}"
